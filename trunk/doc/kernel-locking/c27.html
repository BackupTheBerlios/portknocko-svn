<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>The Problem With Concurrency</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="Unreliable Guide To Locking"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Introduction"
HREF="c20.html"><LINK
REL="NEXT"
TITLE="Locking in the Linux Kernel"
HREF="c93.html"></HEAD
><BODY
CLASS="chapter"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>Unreliable Guide To Locking</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="c20.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="c93.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="chapter"
><H1
><A
NAME="races"
></A
>Chapter 2. The Problem With Concurrency</H1
><P
>&#13;      (Skip this if you know what a Race Condition is).
    </P
><P
>&#13;      In a normal program, you can increment a counter like so:
    </P
><PRE
CLASS="programlisting"
>&#13;      very_important_count++;
    </PRE
><P
>&#13;      This is what they would expect to happen:
    </P
><DIV
CLASS="table"
><A
NAME="AEN33"
></A
><P
><B
>Table 2-1. Expected Results</B
></P
><TABLE
BORDER="1"
CLASS="CALSTABLE"
><COL><COL><THEAD
><TR
><TH
>Instance 1</TH
><TH
>Instance 2</TH
></TR
></THEAD
><TBODY
><TR
><TD
>read very_important_count (5)</TD
><TD
>&nbsp;</TD
></TR
><TR
><TD
>add 1 (6)</TD
><TD
>&nbsp;</TD
></TR
><TR
><TD
>write very_important_count (6)</TD
><TD
>&nbsp;</TD
></TR
><TR
><TD
>&nbsp;</TD
><TD
>read very_important_count (6)</TD
></TR
><TR
><TD
>&nbsp;</TD
><TD
>add 1 (7)</TD
></TR
><TR
><TD
>&nbsp;</TD
><TD
>write very_important_count (7)</TD
></TR
></TBODY
></TABLE
></DIV
><P
>&#13;     This is what might happen:
    </P
><DIV
CLASS="table"
><A
NAME="AEN60"
></A
><P
><B
>Table 2-2. Possible Results</B
></P
><TABLE
BORDER="1"
CLASS="CALSTABLE"
><COL><COL><THEAD
><TR
><TH
>Instance 1</TH
><TH
>Instance 2</TH
></TR
></THEAD
><TBODY
><TR
><TD
>read very_important_count (5)</TD
><TD
>&nbsp;</TD
></TR
><TR
><TD
>&nbsp;</TD
><TD
>read very_important_count (5)</TD
></TR
><TR
><TD
>add 1 (6)</TD
><TD
>&nbsp;</TD
></TR
><TR
><TD
>&nbsp;</TD
><TD
>add 1 (6)</TD
></TR
><TR
><TD
>write very_important_count (6)</TD
><TD
>&nbsp;</TD
></TR
><TR
><TD
>&nbsp;</TD
><TD
>write very_important_count (6)</TD
></TR
></TBODY
></TABLE
></DIV
><DIV
CLASS="sect1"
><H1
CLASS="sect1"
><A
NAME="race-condition"
>2.1. Race Conditions and Critical Regions</A
></H1
><P
>&#13;      This overlap, where the result depends on the
      relative timing of multiple tasks, is called a <I
CLASS="firstterm"
>race condition</I
>.
      The piece of code containing the concurrency issue is called a
      <I
CLASS="firstterm"
>critical region</I
>.  And especially since Linux starting running
      on SMP machines, they became one of the major issues in kernel
      design and implementation.
    </P
><P
>&#13;      Preemption can have the same effect, even if there is only one
      CPU: by preempting one task during the critical region, we have
      exactly the same race condition.  In this case the thread which
      preempts might run the critical region itself.
    </P
><P
>&#13;      The solution is to recognize when these simultaneous accesses
      occur, and use locks to make sure that only one instance can
      enter the critical region at any time.  There are many
      friendly primitives in the Linux kernel to help you do this.
      And then there are the unfriendly primitives, but I'll pretend
      they don't exist.
    </P
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="c20.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="c93.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Introduction</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Locking in the Linux Kernel</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>