<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 7.1.2" />
<style type="text/css">
/* Debug borders */
p, li, dt, dd, div, pre, h1, h2, h3, h4, h5, h6 {
/*
  border: 1px solid red;
*/
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
}

strong {
  font-weight: bold;
}

tt {
  color: navy;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  font-family: sans-serif;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1 {
  border-bottom: 2px solid silver;
}
h2 {
  border-bottom: 2px solid silver;
  padding-top: 0.5em;
}

div.sectionbody {
  font-family: serif;
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

pre {
  padding: 0;
  margin: 0;
}

span#author {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  font-size: 1.2em;
}
span#email {
}
span#revision {
  font-family: sans-serif;
}

div#footer {
  font-family: sans-serif;
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
div#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
div#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

div#preamble,
div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-right: 10%;
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.5em;
  margin-bottom: 2.5em;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  font-family: sans-serif;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock > div.content {
  padding-left: 2.0em;
}

div.attribution {
  text-align: right;
}
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 2px solid silver;
}

div.exampleblock > div.content {
  border-left: 2px solid silver;
  padding: 0.5em;
}

div.verseblock div.content {
  white-space: pre;
}

div.imageblock div.content { padding-left: 0; }
div.imageblock img { border: 1px solid silver; }
span.image img { border-style: none; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: italic;
}
dd > *:first-child {
  margin-top: 0;
}

ul, ol {
    list-style-position: outside;
}
ol.olist2 {
  list-style-type: lower-alpha;
}

div.tableblock > table {
  border: 3px solid #527bbd;
}
thead {
  font-family: sans-serif;
  font-weight: bold;
}
tfoot {
  font-weight: bold;
}

div.hlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
td.hlist1 {
  vertical-align: top;
  font-style: italic;
  padding-right: 0.8em;
}
td.hlist2 {
  vertical-align: top;
}

@media print {
  div#footer-badges { display: none; }
}
/* Workarounds for IE6's broken and incomplete CSS2. */

div.sidebar-content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}
div.sidebar-title, div.image-title {
  font-family: sans-serif;
  font-weight: bold;
  margin-top: 0.0em;
  margin-bottom: 0.5em;
}

div.listingblock div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock-content {
  padding-left: 2.0em;
}

div.exampleblock-content {
  border-left: 2px solid silver;
  padding-left: 0.5em;
}
</style>
<title>PORTKNOCKO PROJECT</title>
</head>
<body>
<div id="header">
<h1>PORTKNOCKO PROJECT</h1>
</div>
<div id="preamble">
<div class="sectionbody">
<p>The PortKnockO Project is composed of two parts: an iptables module
(user space) and a netfilter module (kernel space). The first one
is an iptables extension, and the other one is a netfilter extension.</p>
<p>Both modules are used to implement Port Knocking, a stealthy system
for network authentication across closed ports. For instance, this
can be used to avoid brute force attacks to ssh or ftp services.</p>
<p>They are also implement SPA (Simple Packet Authentication).</p>
</div>
</div>
<h2>INSTALLATION</h2>
<div class="sectionbody">
<p>Anonymous SVN Access via SVN:</p>
<div class="listingblock">
<div class="content">
<pre><tt>svn checkout svn://svn.berlios.de/portknocko/trunk</tt></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><tt># cd portknocko
# ~/portknocko/cd iptables
# ~/portknocko/iptables/make clean
# ~/portknocko/iptables/make
# ~/portknocko/iptables/make install

# cd ../kernel
# ~/portknocko/kernel/make clean
# ~/portknocko/kernel/make
# ~/portknocko/kernel/make install

# depmod -Ae</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">if you use: "insmod ./ipt_pknock.ko", first you should run "modprobe cn" to
load the netlink connector.</td>
</tr></table>
</div>
</div>
<h2>USAGE:</h2>
<div class="sectionbody">
<p>We will show you some different possibilities on how to use this module:</p>
<h3>1) "the simplest way", one rule portknocking:</h3>
<div class="listingblock">
<div class="content">
<pre><tt># iptables -P INPUT DROP
# iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# iptables -A INPUT -p tcp -m state --state NEW
        -m pknock --knockports 2002,2001,2004 --name SSH
        -m tcp --dport 22 -j ACCEPT</tt></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><tt>$ telnet yourserver 2002 # first knock
$ telnet yourserver 2001
$ telnet yourserver 2004 # last knock

$ ssh user@yourserver</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">All knocks and traffic must be TCP packets.</td>
</tr></table>
</div>
</div>
<h2>options:</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre><tt>[--time seconds]        -&gt; max time between knocks.
[--strict]              -&gt; if the peer fails one knock during the
                        sequence, it must start over.</tt></pre>
</div></div>
<h3>2) "the SPA way", hmac auth with two iptables rules:</h3>
<p>You can achieve nonreplayable and nonspoofable.</p>
<div class="listingblock">
<div class="content">
<pre><tt># iptables -P INPUT DROP
# iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# iptables -A INPUT -p udp -m state --state NEW
        -m pknock --knockports 2000 --name SSH
        --opensecret your_opensecret --closesecret your_closesecret
        -j DROP
# iptables -A INPUT -p tcp -m state --state NEW
        -m pknock --checkip --name SSH -m tcp --dport 22 -j ACCEPT</tt></pre>
</div></div>
<p>This way you must send the UDP knock packet with a payload containing a sha256 hmac
digest:</p>
<div class="literalblock">
<div class="content">
<pre><tt>sha256_mac(your_opensecret, your_ip, epoch_min)</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">"epoch_min" is the value of the minutes since January 1st 1970, so you must
keep you hardware clocks sync. You can do it this way:</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content">
<pre><tt># rdate time-a.nist.gov         # this will set your system clock
# /sbin/hwclock --systohc --utc # this will set your hardware clock to UTC</tt></pre>
</div></div>
<p>After the knock is accepted, you can start the TCP traffic through port 22. When you
finish, close the door (see the example below) to avoid others come after you and
use your same IP to log-in.</p>
<p>We provide you a client for knocking the SPA way:</p>
<div class="listingblock">
<div class="content">
<pre><tt># cd test
# util/knock.sh &lt;IP src&gt; &lt;PORT dst&gt; &lt;secret&gt; &lt;IP dst&gt;</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">You must have python-crypto installed.</td>
</tr></table>
</div>
<p>e.g:</p>
<div class="listingblock">
<div class="content">
<pre><tt># ~/util/knock.sh 192.168.0.1 2000 your_opensecret</tt></pre>
</div></div>
<p>After you finish using the service you should "close the door":</p>
<p>e.g:</p>
<div class="listingblock">
<div class="content">
<pre><tt># ~/util/knock.sh 192.168.0.1 2000 your_closesecret</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Remember that these are One Time Passwords, so you can not reuse the same
hmac, letting you knock just once per minute (because of the epoch_min).</td>
</tr></table>
</div>
<p>In case you are being NATed, just replace &lt;IP src&gt; with the NATed IP.</p>
<p>The security protocol used in this module is based on a userspace implementation
called Tumbler: http://tumbler.sourceforge.net/</p>
</div>
<h2>COMUNICATION WITH THE USERSPACE:</h2>
<div class="sectionbody">
<p>In other port knocking implementations, there is a server that periodically
looks up the firewall logs for the correct sequence of port knocks. When it is
found, the server usually sets a new iptable rule.</p>
<p>A great possibility would be if the server just listens and receives a msg
when something interesting happens. If this would be possible, surely it would
simplify the architecture of the server and make it more efficient.</p>
<p>Thanks to netlink sockets, a message from this kernel module is sent to the
userspace each time a peer match a knock sequence.</p>
<p>So for example you could have a server listening in the userspace and when
someone matches the sequence, the server receives a msg allowing you to do
whatever you want. e.g: you could start a webserver, add the peer to a whilelist,
etc. everything in a smooth and efficient way.</p>
<p>Step by step:</p>
<p>1) Compile the module.
2) Load the module: insmod ./ipt_pknock.ko nl_multicast_group=&lt;value&gt;
3) Load the server. There is a minimal userspace implementation in
experiments/netlink_broadcast that prints a msg each time someone matches the
sequence.</p>
</div>
<h2>TESTS: (be careful, it will erase your loaded iptables rules)</h2>
<div class="sectionbody">
<p>If you are a developer, you may want to run these while you refactor the code</p>
<div class="listingblock">
<div class="content">
<pre><tt># ~/portknocko/cd test
# ~/portknocko/test/./testrunner.sh all.test</tt></pre>
</div></div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 10-Jun-2007 12:16:10 ART
</div>
</div>
</body>
</html>
