###### LOAD WITHOUT SECRET ######
load

rule "SSH" "2000,2001" "22" "--secure"
expect "SSH,(A)" 

knock "11.10.0.1" "22"  
expect "The secret has not been initialized"
knock "11.10.0.1" "2000"
expect "The secret has not been initialized"

unload
#################################


###### LOAD WITH SECRET! ######
SECRET="whatasecret"

load secret=$SECRET

rule "SSH" "2000,2001" "22" "--secure"
expect "SSH,(A)" 

knock "11.10.0.1" "22"  
expect "!PASS OK"
knock "11.10.0.1" "2000"
expect "!MATCHING"
knock "11.10.0.1" "2001"
expect "!MATCHING,!ALLOWED"
knock "11.10.0.1" "22"
expect "!PASS OK"

#bad secret
set_hmac "qweasdzxc" "11.10.0.1" 

knock "11.10.0.1" "2000"
expect "!MATCHING"

#bad ipsrc
set_hmac $SECRET "12.10.0.1" 

knock "11.10.0.1" "2000"
expect "!MATCHING"

# GOOD!
set_hmac $SECRET "11.10.0.1" 

knock "11.10.0.1" "2000"
expect "MATCHING"
knock "11.10.0.1" "2001"
expect "ALLOWED"
knock "11.10.0.1" "22"
expect "PASS OK"

unload
#################################
